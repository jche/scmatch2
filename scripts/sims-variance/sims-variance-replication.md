---
editor_options: 
  markdown: 
    wrap: 72
---

# Replicating the Sims-Variance (Toy Inference) Results

This document explains how to reproduce the simulation results used in
the variance/inference toy example.

## Project layout

Key scripts:

-   `scripts/sims-variance/0_sim_inference_utils.R`\
    Core data generation + matching + inference functions (including
    `sim_master()` and `toy_match_infer()`).

-   `scripts/sims-variance/1_parallel_sim_inference.R`\
    One SLURM array task entrypoint. Each task runs a single simulation
    iteration across overlap scenarios and saves `.rds` outputs.

-   `scripts/sims-variance/2_collect_results.R`\
    Collects individual `.rds` outputs into a single CSV.

-   `scripts/sims-variance/3_summarize_results.R`\
    Produces summary tables (CSV) for each inference method.

Output directories (created automatically): - Individual runs:
`data/outputs/sims-variance/individual/` - Combined CSV:
`data/outputs/sims-variance/combined_results.csv` - Tables:
`tables/sims-variance/`

------------------------------------------------------------------------

## Simulation setting (toy example)

We simulate:

-   `nt = 100` treated units
-   `nc = 500` control units
-   Two-dimensional covariates `(X1, X2)` generated by `gen_df_adv()`
-   Treatment effect: `tau(X1,X2) = 3*X1 + 3*X2`
-   Outcome baseline `f0(X1,X2)` proportional to a bivariate normal
    density centered at `(0.5,0.5)` with covariance `[[1,0.8],[0.8,1]]`,
    scaled by 20
-   Noise: homoskedastic with SD `f0_sd = 0.5`

Overlap is controlled by the proportion of controls sampled uniformly on
the unit square (`prop_nc_unif`): - very_low = 2/3 - low = 1/2 - mid =
1/3 - high = 1/5 - very_high = 1/10

Matching uses an adaptive caliper scheme (k=5) and SCM aggregation (see
`toy_match_infer()`).

------------------------------------------------------------------------

## Seeds (important for reproducibility)

Each SLURM array task corresponds to an `iteration` integer (typically
1..500).

We use a deterministic seed mapping to make results reproducible across
clusters:

For each `(iteration, overlap_label, error_label, N)`:

```         
seed = iteration
+ 1000 * (overlap_index - 1)
+ 10000 * (error_index - 1)
+ 100000 * (N_index - 1)
```

Where: - `overlap_index` is the index of overlap_label in
`c("very_low","low","mid","high","very_high")` - `error_index` is the
index of error_label in
`c("homoskedastic","covariate_dep","treatment_dep")` - `N_index` is the
index of `N` in `c(600)` (fixed here)

This mapping is implemented in `sim_master()` in
`0_sim_inference_utils.R`.

------------------------------------------------------------------------

## Run one iteration locally (RStudio)

1)  Open the project in RStudio so `here::here()` resolves correctly.

2)  Source the utilities:

``` r
source(here::here("scripts/sims-variance/0_sim_inference_utils.R"))
```

3.  Run one iteration manually (example):

``` r
iter <- 1
overlap_label <- "very_low"
error_label <- "homoskedastic"

# prop_nc_unif mapping must match sim_master()
prop_nc_unif_values <- c(
  very_low = 2/3,
  low = 1/2,
  mid = 1/3,
  high = 1/5,
  very_high = 1/10
)
prop_nc_unif <- prop_nc_unif_values[[overlap_label]]

res1 <- toy_match_infer(
  i = iter,
  overlap_label = overlap_label,
  error_label = error_label,
  prop_nc_unif = prop_nc_unif,
  nc = 500,
  nt = 100,
  f0_sd = 0.5,
  ctr_dist = 0.5,
  nbins = 6,
  include_bootstrap = FALSE,
  seed_addition = 123,
  grid_id = 1,
  verbose = TRUE
)

print(res1)
```
